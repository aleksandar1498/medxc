
 CREATE SEQUENCE PATIENT_SEQ
 START WITH     1
 INCREMENT BY   1
 MAXVALUE 1000000
 NOCACHE
 NOCYCLE;
 
 CREATE TABLE STATUS
  (
    STATUS_ID NUMBER (1) GENERATED BY DEFAULT AS IDENTITY,
    STATUS_NAME CHAR (10 CHAR) NOT NULL,
    PRIMARY KEY(STATUS_ID)
  );

 CREATE TABLE TESTTYPE
  (
    TTYPE_ID NUMBER (4) GENERATED BY DEFAULT AS IDENTITY,
    TEST_NAME CHAR (40 CHAR) NOT NULL ,
    REF_LIMITS VARCHAR2 (200 CHAR),
    PRIMARY KEY(TTYPE_ID)
  );

CREATE TABLE SPECIALTY
  (
    SPEC_ID NUMBER (4) GENERATED BY DEFAULT AS IDENTITY,
    SPEC_NAME CHAR (50 CHAR) NOT NULL,
    PRIMARY KEY(SPEC_ID)
  );

CREATE TABLE PATIENT 
(
    PIN CHAR (10 CHAR),
    EMAIL CHAR (50 CHAR),
    NAME CHAR (70 CHAR) NOT NULL,
    PHONE CHAR (20 CHAR) NOT NULL,
    SEX CHAR (1 CHAR),
    ADDRESS CHAR (100 CHAR),
    PRIMARY KEY(PIN)
);

CREATE TABLE DOCTOR (
    DOC_NUM CHAR(10 CHAR),
    DOC_NAME CHAR(70 CHAR) NOT NULL,
    EMAIL CHAR(50 CHAR) NOT NULL,
    PHONE CHAR(20 CHAR) NOT NULL,
    PRIMARY KEY (DOC_NUM)
);

CREATE TABLE APPOINTMENT
  (
    APP_ID NUMBER (10) GENERATED BY DEFAULT AS IDENTITY,
    APP_DATE_TIME DATE NOT NULL,
    STATUS_ID NUMBER (1) NOT NULL,
    SPEC_ID NUMBER (4) NOT NULL,
    PIN CHAR (10 CHAR),
    DOC_NUM CHAR (10 CHAR) NOT NULL,
    PRIMARY KEY(APP_ID),
    FOREIGN KEY (SPEC_ID) REFERENCES SPECIALTY(SPEC_ID),
    FOREIGN KEY (STATUS_ID) REFERENCES STATUS(STATUS_ID),
    FOREIGN KEY (PIN) REFERENCES PATIENT(PIN),
    FOREIGN KEY (DOC_NUM) REFERENCES DOCTOR(DOC_NUM)
  );

 CREATE TABLE APP_RECORD
 (
    APP_ID NUMBER(10),
    ANAMNESIS VARCHAR2(200 CHAR),
    OBSERVATION VARCHAR2(200 CHAR),
    THERAPY VARCHAR2(200 CHAR),
    PRIMARY KEY (APP_ID),
    FOREIGN KEY (APP_ID) REFERENCES APPOINTMENT(APP_ID)
 );

CREATE TABLE APP_TEST(
    TTYPE_ID NUMBER(4),
    APP_ID NUMBER(10),
    VAL NUMBER (10,3),
    DESCRIPTION VARCHAR2 (200 BYTE),
    DUE_DATE DATE,
    TEST_DATE DATE,
    PRIMARY KEY (TTYPE_ID,APP_ID),
    FOREIGN KEY (TTYPE_ID) REFERENCES TESTTYPE(TTYPE_ID),
    FOREIGN KEY (APP_ID) REFERENCES APPOINTMENT(APP_ID)
);

CREATE TABLE DOC_SPEC(
    DOC_NUM CHAR(10 CHAR),
    SPEC_ID NUMBER(4),
    ODD NUMBER (1),
    START_HOUR DATE,
    NUM_APPOINT NUMBER(2),
    DUR_APPOINT NUMBER(3),  --INTERVAL
    PRIMARY KEY (SPEC_ID,DOC_NUM, ODD),
    FOREIGN KEY (SPEC_ID) REFERENCES SPECIALTY(SPEC_ID),
    FOREIGN KEY (DOC_NUM) REFERENCES DOCTOR(DOC_NUM)
);

call DBMS_UTILITY.EXEC_DDL_STATEMENT(
   'CREATE OR REPLACE TRIGGER PATIENT_TRG 
      BEFORE INSERT ON PATIENT 
      FOR EACH ROW WHEN (NEW.PIN IS NULL) 
    BEGIN 
      :NEW.PIN := PATIENT_SEQ.NEXTVAL; 
    END;'
);
